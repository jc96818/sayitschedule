// Prisma Schema for Say It Schedule
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum UserRole {
  super_admin
  admin
  admin_assistant
  staff
}

enum Gender {
  male
  female
  other
}

enum Status {
  active
  inactive
}

enum ScheduleStatus {
  draft
  published
}

enum RuleCategory {
  gender_pairing
  session
  availability
  specific_pairing
  certification
}

enum AvailabilityStatus {
  pending
  approved
  rejected
}

// Session status for tracking appointment lifecycle
enum SessionStatus {
  pending       // Awaiting approval (self-booked with requires_approval)
  scheduled
  confirmed
  checked_in
  in_progress
  completed
  cancelled
  late_cancel
  no_show
}

// Cancellation reasons for tracking why sessions were cancelled
enum CancellationReason {
  patient_request
  caregiver_request
  therapist_unavailable
  weather
  illness
  scheduling_conflict
  other
}

// Booking source - tracks how an appointment was booked
enum BookingSource {
  admin          // Booked by admin/staff in dashboard
  staff          // Booked by assigned therapist
  portal         // Booked via patient portal
  ai_voice       // Booked via AI voice command
  api            // Booked via external API
}

// BAA (Business Associate Agreement) status
enum BaaStatus {
  not_started
  awaiting_org_signature
  awaiting_vendor_signature
  executed
  voided
  superseded
}

// Transcription provider options
enum TranscriptionProvider {
  aws_medical
  aws_standard
}

enum MedicalSpecialty {
  PRIMARYCARE
  CARDIOLOGY
  NEUROLOGY
  ONCOLOGY
  RADIOLOGY
  UROLOGY
}

// Business Type Templates for organization customization
model BusinessTypeTemplate {
  id                      String   @id @default(cuid())
  name                    String   @db.VarChar(100)
  description             String?
  isDefault               Boolean  @default(false) @map("is_default")
  isActive                Boolean  @default(true) @map("is_active")

  // Labels
  staffLabel              String   @default("Staff") @map("staff_label") @db.VarChar(50)
  staffLabelSingular      String   @default("Staff Member") @map("staff_label_singular") @db.VarChar(50)
  patientLabel            String   @default("Patients") @map("patient_label") @db.VarChar(50)
  patientLabelSingular    String   @default("Patient") @map("patient_label_singular") @db.VarChar(50)
  roomLabel               String   @default("Rooms") @map("room_label") @db.VarChar(50)
  roomLabelSingular       String   @default("Room") @map("room_label_singular") @db.VarChar(50)
  certificationLabel      String   @default("Certifications") @map("certification_label") @db.VarChar(50)
  equipmentLabel          String   @default("Equipment") @map("equipment_label") @db.VarChar(50)

  // Suggested options
  suggestedCertifications Json     @default("[]") @map("suggested_certifications")
  suggestedRoomEquipment  Json     @default("[]") @map("suggested_room_equipment")

  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @default(now()) @updatedAt @map("updated_at")

  organizations           Organization[]

  @@map("business_type_templates")
}

// Organizations
model Organization {
  id             String   @id @default(cuid())
  name           String   @db.VarChar(255)
  subdomain      String   @unique @db.VarChar(63)
  logoUrl        String?  @map("logo_url")
  primaryColor   String   @default("#2563eb") @map("primary_color") @db.VarChar(7)
  secondaryColor String   @default("#1e40af") @map("secondary_color") @db.VarChar(7)
  status         Status   @default(active)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  // HIPAA compliance
  requiresHipaa  Boolean  @default(false) @map("requires_hipaa")

  // Transcription settings
  transcriptionProvider  TranscriptionProvider @default(aws_medical) @map("transcription_provider")
  medicalSpecialty       MedicalSpecialty      @default(PRIMARYCARE) @map("medical_specialty")

  // Template reference
  businessTypeTemplateId  String?  @map("business_type_template_id")
  businessTypeTemplate    BusinessTypeTemplate? @relation(fields: [businessTypeTemplateId], references: [id])

  // Custom labels (per-org overrides)
  staffLabel              String   @default("Staff") @map("staff_label") @db.VarChar(50)
  staffLabelSingular      String   @default("Staff Member") @map("staff_label_singular") @db.VarChar(50)
  patientLabel            String   @default("Patients") @map("patient_label") @db.VarChar(50)
  patientLabelSingular    String   @default("Patient") @map("patient_label_singular") @db.VarChar(50)
  roomLabel               String   @default("Rooms") @map("room_label") @db.VarChar(50)
  roomLabelSingular       String   @default("Room") @map("room_label_singular") @db.VarChar(50)
  certificationLabel      String   @default("Certifications") @map("certification_label") @db.VarChar(50)
  equipmentLabel          String   @default("Equipment") @map("equipment_label") @db.VarChar(50)
  suggestedCertifications Json     @default("[]") @map("suggested_certifications")
  suggestedRoomEquipment  Json     @default("[]") @map("suggested_room_equipment")

  users          User[]
  staff          Staff[]
  patients       Patient[]
  rules          Rule[]
  rooms          Room[]
  schedules      Schedule[]
  auditLogs      AuditLog[]
  customHolidays CustomHoliday[]
  baaAgreements  BaaAgreement[]

  // Settings and features
  settings       OrganizationSettings?
  features       OrganizationFeatures?

  @@map("organizations")
}

// Organization Settings - Business configuration
model OrganizationSettings {
  id                    String       @id @default(cuid())
  organizationId        String       @unique @map("organization_id")
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Business Hours (JSON structure)
  // { monday: { open: true, start: "08:00", end: "18:00" }, tuesday: {...}, ... }
  businessHours         Json         @default("{}") @map("business_hours")
  timezone              String       @default("America/New_York") @db.VarChar(50)

  // Session Defaults
  defaultSessionDuration Int         @default(60) @map("default_session_duration")  // minutes
  slotInterval          Int          @default(30) @map("slot_interval")  // scheduling grid interval in minutes

  // Cancellation Policy
  lateCancelWindowHours Int          @default(24) @map("late_cancel_window_hours")

  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @default(now()) @updatedAt @map("updated_at")

  @@map("organization_settings")
}

// Organization Features - Feature toggles for tiered pricing
model OrganizationFeatures {
  id                    String       @id @default(cuid())
  organizationId        String       @unique @map("organization_id")
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // ═══════════════════════════════════════════════════════════════════
  // FEATURE TOGGLES - Control access to premium/optional features
  // ═══════════════════════════════════════════════════════════════════

  // ─── Reminder Features ───
  emailRemindersEnabled Boolean      @default(true) @map("email_reminders_enabled")
  smsRemindersEnabled   Boolean      @default(false) @map("sms_reminders_enabled")
  reminderHours         Json         @default("[24, 2]") @map("reminder_hours")

  // ─── Patient/Caregiver Portal ───
  patientPortalEnabled  Boolean      @default(false) @map("patient_portal_enabled")
  portalAllowCancel     Boolean      @default(true) @map("portal_allow_cancel")
  portalAllowReschedule Boolean      @default(false) @map("portal_allow_reschedule")
  portalRequireConfirmation Boolean  @default(true) @map("portal_require_confirmation")

  // ─── Self-Booking Settings ───
  selfBookingEnabled      Boolean    @default(false) @map("self_booking_enabled")
  selfBookingLeadTimeHours Int       @default(24) @map("self_booking_lead_time_hours")     // Minimum hours before appointment
  selfBookingMaxFutureDays Int       @default(30) @map("self_booking_max_future_days")     // How far ahead can book
  selfBookingRequiresApproval Boolean @default(false) @map("self_booking_requires_approval") // If true, books as 'pending'

  // ─── Portal Customization ───
  // These settings allow organizations to heavily customize their patient portal appearance
  portalWelcomeTitle      String     @default("Welcome to Your Patient Portal") @map("portal_welcome_title") @db.VarChar(100)
  portalWelcomeMessage    String     @default("Sign in to view your appointments and manage your schedule.") @map("portal_welcome_message") @db.VarChar(500)
  portalPrimaryColor      String?    @map("portal_primary_color") @db.VarChar(7)      // Override org color for portal (hex)
  portalSecondaryColor    String?    @map("portal_secondary_color") @db.VarChar(7)    // Override org color for portal (hex)
  portalLogoUrl           String?    @map("portal_logo_url") @db.VarChar(500)         // Override org logo for portal
  portalBackgroundUrl     String?    @map("portal_background_url") @db.VarChar(500)   // Custom background image
  portalShowOrgName       Boolean    @default(true) @map("portal_show_org_name")      // Show org name on portal
  portalContactEmail      String?    @map("portal_contact_email") @db.VarChar(255)    // Support email shown to portal users
  portalContactPhone      String?    @map("portal_contact_phone") @db.VarChar(20)     // Support phone shown to portal users
  portalFooterText        String?    @map("portal_footer_text") @db.VarChar(500)      // Custom footer message
  portalTermsUrl          String?    @map("portal_terms_url") @db.VarChar(500)        // Link to terms of service
  portalPrivacyUrl        String?    @map("portal_privacy_url") @db.VarChar(500)      // Link to privacy policy

  // ─── Reporting Features ───
  advancedReportsEnabled Boolean     @default(false) @map("advanced_reports_enabled")
  reportExportEnabled   Boolean      @default(true) @map("report_export_enabled")

  // ─── Voice Features ───
  voiceCommandsEnabled  Boolean      @default(true) @map("voice_commands_enabled")
  medicalTranscribeEnabled Boolean   @default(false) @map("medical_transcribe_enabled")

  // ─── Integration Features (Phase 2) ───
  apiAccessEnabled      Boolean      @default(false) @map("api_access_enabled")
  webhooksEnabled       Boolean      @default(false) @map("webhooks_enabled")

  // ─── Limits ───
  maxStaff              Int?         @map("max_staff")
  maxPatients           Int?         @map("max_patients")
  maxRemindersPerMonth  Int?         @map("max_reminders_per_month")

  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @default(now()) @updatedAt @map("updated_at")

  @@map("organization_features")
}

// Users
model User {
  id             String        @id @default(cuid())
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])
  email          String        @unique @db.VarChar(255)
  passwordHash   String?       @map("password_hash") @db.VarChar(255)
  name           String        @db.VarChar(255)
  role           UserRole
  createdAt      DateTime      @default(now()) @map("created_at")
  lastLogin      DateTime?     @map("last_login")

  // MFA fields (available for all users)
  mfaEnabled        Boolean   @default(false) @map("mfa_enabled")
  mfaRequired       Boolean   @default(false) @map("mfa_required")
  mfaSecret         String?   @map("mfa_secret") @db.VarChar(255)
  mfaBackupCodes    String[]  @default([]) @map("mfa_backup_codes")
  passwordChangedAt DateTime? @map("password_changed_at")

  staff              Staff[]
  rulesCreated       Rule[]
  schedulesCreated   Schedule[]
  auditLogs          AuditLog[]
  passwordResetTokens PasswordResetToken[]

  // Session status relations
  sessionsStatusUpdated  Session[] @relation("SessionStatusUpdater")
  sessionsCancelled      Session[] @relation("SessionCanceller")
  sessionsConfirmed      Session[] @relation("SessionConfirmer")

  @@map("users")
}

// Staff (Therapists)
model Staff {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])
  userId         String?      @map("user_id")
  user           User?        @relation(fields: [userId], references: [id])
  name           String       @db.VarChar(255)
  gender         Gender
  email          String?      @db.VarChar(255)
  phone          String?      @db.VarChar(20)
  certifications Json         @default("[]")
  defaultHours   Json?        @map("default_hours")
  status         Status       @default(active)
  hireDate       DateTime?    @map("hire_date")
  createdAt      DateTime     @default(now()) @map("created_at")

  sessions           Session[]
  staffAvailability  StaffAvailability[]

  @@map("staff")
}

// Rooms
model Room {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String       @db.VarChar(255)
  capabilities   Json         @default("[]")
  description    String?
  status         Status       @default(active)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @default(now()) @updatedAt @map("updated_at")

  sessions         Session[]
  preferredByPatients Patient[] @relation("PreferredRoom")

  @@map("rooms")
}

// Patients
model Patient {
  id                       String       @id @default(cuid())
  organizationId           String       @map("organization_id")
  organization             Organization @relation(fields: [organizationId], references: [id])
  name                     String       @db.VarChar(255)
  identifier               String?      @db.VarChar(50)
  gender                   Gender
  sessionFrequency         Int          @default(2) @map("session_frequency")
  preferredTimes           Json?        @map("preferred_times")
  requiredCertifications   Json         @default("[]") @map("required_certifications")
  preferredRoomId          String?      @map("preferred_room_id")
  preferredRoom            Room?        @relation("PreferredRoom", fields: [preferredRoomId], references: [id])
  requiredRoomCapabilities Json         @default("[]") @map("required_room_capabilities")
  notes                    String?
  status                   Status       @default(active)
  createdAt                DateTime     @default(now()) @map("created_at")

  // Contact information (for reminders and portal access)
  email                    String?      @db.VarChar(255)
  phone                    String?      @db.VarChar(20)

  // Guardian/Caregiver contact (for minors or dependent patients)
  guardianName             String?      @map("guardian_name") @db.VarChar(255)
  guardianEmail            String?      @map("guardian_email") @db.VarChar(255)
  guardianPhone            String?      @map("guardian_phone") @db.VarChar(20)
  guardianRelationship     String?      @map("guardian_relationship") @db.VarChar(50)

  // Session preferences
  defaultSessionDuration   Int?         @map("default_session_duration")  // minutes, overrides org default
  genderPreference         Gender?      @map("gender_preference")  // preferred therapist gender

  sessions         Session[]
  contacts         PatientContact[]

  @@map("patients")
}

// Rules
model Rule {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])
  category       RuleCategory
  description    String
  ruleLogic      Json         @map("rule_logic")
  priority       Int          @default(0)
  isActive       Boolean      @default(true) @map("is_active")
  createdById    String       @map("created_by")
  createdBy      User         @relation(fields: [createdById], references: [id])
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @default(now()) @updatedAt @map("updated_at")

  @@map("rules")
}

// Schedules
model Schedule {
  id            String         @id @default(cuid())
  organizationId String        @map("organization_id")
  organization  Organization   @relation(fields: [organizationId], references: [id])
  weekStartDate DateTime       @map("week_start_date")
  status        ScheduleStatus @default(draft)
  createdById   String         @map("created_by")
  createdBy     User           @relation(fields: [createdById], references: [id])
  createdAt     DateTime       @default(now()) @map("created_at")
  publishedAt   DateTime?      @map("published_at")
  version       Int            @default(1)

  sessions Session[]

  @@map("schedules")
}

// Sessions
model Session {
  id          String   @id @default(cuid())
  scheduleId  String   @map("schedule_id")
  schedule    Schedule @relation(fields: [scheduleId], references: [id])
  therapistId String   @map("therapist_id")
  therapist   Staff    @relation(fields: [therapistId], references: [id])
  patientId   String   @map("patient_id")
  patient     Patient  @relation(fields: [patientId], references: [id])
  roomId      String?  @map("room_id")
  room        Room?    @relation(fields: [roomId], references: [id])
  date        DateTime
  startTime   String   @map("start_time") @db.VarChar(5)
  endTime     String   @map("end_time") @db.VarChar(5)
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Session status tracking
  status            SessionStatus       @default(scheduled)
  actualStartTime   DateTime?           @map("actual_start_time")
  actualEndTime     DateTime?           @map("actual_end_time")
  statusUpdatedAt   DateTime?           @map("status_updated_at")
  statusUpdatedById String?             @map("status_updated_by_id")
  statusUpdatedBy   User?               @relation("SessionStatusUpdater", fields: [statusUpdatedById], references: [id])

  // Cancellation details
  cancellationReason CancellationReason? @map("cancellation_reason")
  cancellationNotes  String?             @map("cancellation_notes")
  cancelledAt        DateTime?           @map("cancelled_at")
  cancelledById      String?             @map("cancelled_by_id")
  cancelledBy        User?               @relation("SessionCanceller", fields: [cancelledById], references: [id])

  // Confirmation tracking (for patient portal)
  confirmedAt        DateTime?           @map("confirmed_at")
  confirmedById      String?             @map("confirmed_by_id")
  confirmedBy        User?               @relation("SessionConfirmer", fields: [confirmedById], references: [id])

  // Booking metadata (for portal and multi-channel booking)
  bookedByContactId  String?             @map("booked_by_contact_id")  // Portal user who booked
  bookedVia          BookingSource       @default(admin) @map("booked_via")

  @@map("sessions")
}

// Staff Availability (includes time-off requests with approval workflow)
model StaffAvailability {
  id        String   @id @default(cuid())
  staffId   String   @map("staff_id")
  staff     Staff    @relation(fields: [staffId], references: [id])
  date      DateTime
  available Boolean  @default(true)
  startTime String?  @map("start_time") @db.VarChar(5)
  endTime   String?  @map("end_time") @db.VarChar(5)
  reason    String?

  // Request workflow fields
  status          AvailabilityStatus @default(approved)
  requestedAt     DateTime?          @map("requested_at")
  requestedById   String?            @map("requested_by_id")
  reviewedAt      DateTime?          @map("reviewed_at")
  reviewedById    String?            @map("reviewed_by_id")
  reviewerNotes   String?            @map("reviewer_notes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([staffId, date], name: "staff_date_unique")
  @@map("staff_availability")
}

// Password Reset / Invitation Tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique @db.VarChar(64)
  type      TokenType @default(password_reset)
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

enum TokenType {
  password_reset
  invitation
}

// Audit Logs
model AuditLog {
  id             String        @id @default(cuid())
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])
  userId         String?       @map("user_id")
  user           User?         @relation(fields: [userId], references: [id])
  action         String        @db.VarChar(50)
  entityType     String        @map("entity_type") @db.VarChar(50)
  entityId       String        @map("entity_id")
  changes        Json?
  timestamp      DateTime      @default(now())

  @@map("audit_logs")
}

// Federal Holidays
model FederalHoliday {
  id   String   @id @default(cuid())
  year Int
  name String   @db.VarChar(100)
  date DateTime

  @@map("federal_holidays")
}

// Custom Holidays (per organization)
model CustomHoliday {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String       @db.VarChar(100)
  date           DateTime
  reason         String?

  @@map("custom_holidays")
}

// Lead Status for marketing lead tracking
enum LeadStatus {
  new
  contacted
  qualified
  converted
  closed
}

// Leads (captured from landing page)
model Lead {
  id          String     @id @default(cuid())
  name        String     @db.VarChar(255)
  email       String     @db.VarChar(255)
  company     String?    @db.VarChar(255)
  phone       String?    @db.VarChar(50)
  role        String?    @db.VarChar(100)
  message     String?
  status      LeadStatus @default(new)
  source      String     @default("landing_page") @db.VarChar(50)
  notes       String?
  convertedAt DateTime?  @map("converted_at")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("leads")
}

// BAA (Business Associate Agreement)
// Tracks HIPAA Business Associate Agreements per organization
model BaaAgreement {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])
  status         BaaStatus    @default(not_started)

  // Template info for versioning and integrity
  templateName    String  @map("template_name") @db.VarChar(100)
  templateVersion String  @map("template_version") @db.VarChar(20)
  templateSha256  String  @map("template_sha256") @db.VarChar(64)

  // Executed PDF storage and integrity
  executedPdfSha256 String? @map("executed_pdf_sha256") @db.VarChar(64)
  executedPdfPath   String? @map("executed_pdf_path") @db.VarChar(500)

  // Organization signature (covered entity)
  orgSignedAt       DateTime? @map("org_signed_at")
  orgSignerUserId   String?   @map("org_signer_user_id")
  orgSignerName     String?   @map("org_signer_name") @db.VarChar(255)
  orgSignerTitle    String?   @map("org_signer_title") @db.VarChar(255)
  orgSignerEmail    String?   @map("org_signer_email") @db.VarChar(255)
  orgSignerIp       String?   @map("org_signer_ip") @db.VarChar(45)
  orgSignerUserAgent String?  @map("org_signer_user_agent") @db.VarChar(500)

  // Vendor signature (business associate - Say It Schedule)
  vendorSignedAt     DateTime? @map("vendor_signed_at")
  vendorSignerUserId String?   @map("vendor_signer_user_id")
  vendorSignerName   String?   @map("vendor_signer_name") @db.VarChar(255)
  vendorSignerTitle  String?   @map("vendor_signer_title") @db.VarChar(255)

  // E-sign provider integration (for future use with DocuSign, etc.)
  esignProvider    String? @map("esign_provider") @db.VarChar(50)
  esignEnvelopeId  String? @map("esign_envelope_id") @db.VarChar(100)
  esignStatus      String? @map("esign_status") @db.VarChar(50)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("baa_agreements")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PATIENT PORTAL MODELS
// ═══════════════════════════════════════════════════════════════════════════════

// Contact relationship types for portal access
enum ContactRelationship {
  self           // Patient is their own contact (adult patient)
  parent         // Parent of minor patient
  guardian       // Legal guardian
  caregiver      // Professional caregiver
  spouse         // Spouse/partner
  other          // Other relationship
}

// Patient Contacts - Supports multiple contacts per patient with portal access
model PatientContact {
  id                String              @id @default(cuid())
  patientId         String              @map("patient_id")
  patient           Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Contact information
  name              String              @db.VarChar(255)
  email             String?             @db.VarChar(255)
  phone             String?             @db.VarChar(20)
  relationship      ContactRelationship @default(self)

  // Portal access control
  canAccessPortal   Boolean             @default(false) @map("can_access_portal")
  isPrimaryContact  Boolean             @default(false) @map("is_primary_contact")

  // Communication preferences
  emailOptIn        Boolean             @default(true) @map("email_opt_in")
  smsOptIn          Boolean             @default(false) @map("sms_opt_in")

  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @default(now()) @updatedAt @map("updated_at")

  // Portal authentication
  portalSessions    PortalSession[]
  loginTokens       PortalLoginToken[]

  @@index([patientId])
  @@index([email])
  @@map("patient_contacts")
}

// Portal Login Tokens - Magic link / OTP authentication
// Security: Only stores hashed tokens, never plaintext
model PortalLoginToken {
  id          String         @id @default(cuid())
  contactId   String         @map("contact_id")
  contact     PatientContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Token details (hash only - plaintext is never stored)
  tokenHash   String         @unique @map("token_hash") @db.VarChar(64)  // SHA-256 hash
  channel     String         @default("email") @db.VarChar(10)   // "email" or "sms"

  // Expiration and usage
  expiresAt   DateTime       @map("expires_at")
  usedAt      DateTime?      @map("used_at")

  // Security metadata
  ipAddress   String?        @map("ip_address") @db.VarChar(45)
  userAgent   String?        @map("user_agent") @db.VarChar(500)

  createdAt   DateTime       @default(now()) @map("created_at")

  @@index([contactId])
  @@map("portal_login_tokens")
}

// Portal Sessions - Active portal sessions for contacts
model PortalSession {
  id            String         @id @default(cuid())
  contactId     String         @map("contact_id")
  contact       PatientContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Session token (hashed)
  tokenHash     String         @unique @map("token_hash") @db.VarChar(64)

  // Session lifecycle
  expiresAt     DateTime       @map("expires_at")
  lastActivityAt DateTime      @map("last_activity_at")
  revokedAt     DateTime?      @map("revoked_at")

  // Security metadata
  ipAddress     String?        @map("ip_address") @db.VarChar(45)
  userAgent     String?        @map("user_agent") @db.VarChar(500)

  createdAt     DateTime       @default(now()) @map("created_at")

  @@index([contactId])
  @@map("portal_sessions")
}

// ═══════════════════════════════════════════════════════════════════════════════
// BOOKING ENGINE MODELS
// ═══════════════════════════════════════════════════════════════════════════════

// Appointment Holds - Temporary slot reservations during booking
model AppointmentHold {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")

  // Slot details
  staffId        String?      @map("staff_id")
  roomId         String?      @map("room_id")
  date           DateTime
  startTime      String       @map("start_time") @db.VarChar(5)
  endTime        String       @map("end_time") @db.VarChar(5)

  // Hold metadata
  expiresAt      DateTime     @map("expires_at")
  releasedAt     DateTime?    @map("released_at")
  convertedToSessionId String? @map("converted_to_session_id")

  // Who created the hold
  createdByContactId String?  @map("created_by_contact_id")  // Portal user
  createdByUserId    String?  @map("created_by_user_id")     // Staff/Admin user

  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([organizationId, date, startTime])
  @@index([expiresAt])
  @@map("appointment_holds")
}
